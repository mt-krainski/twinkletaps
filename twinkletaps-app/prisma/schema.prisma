generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Profile {
  id        String    @id @db.Uuid
  updatedAt DateTime? @updatedAt @map("updated_at") @db.Timestamptz
  username  String?   @unique
  fullName  String?   @map("full_name")
  avatarUrl String?   @map("avatar_url")
  website   String?

  userWorkspaces UserWorkspace[]
  userDevices    UserDevice[]
  roleAuditLogs  RoleAuditLog[]

  @@map("profiles")
}

model Workspace {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  avatarUrl String?   @map("avatar_url")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  devices        Device[]
  userWorkspaces UserWorkspace[]

  @@map("workspaces")
}

model Device {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  name        String
  avatarUrl   String?   @map("avatar_url")
  deviceUuid  String    @unique @map("device_uuid") @db.Uuid
  mqttTopic   String    @map("mqtt_topic")
  mqttUsername String?  @map("mqtt_username")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userDevices UserDevice[]

  @@unique([name, workspaceId], map: "devices_name_workspace_unique")
  @@index([deletedAt], map: "devices_deleted_at_idx")
  @@index([workspaceId], map: "devices_workspace_id_idx")
  @@map("devices")
}

model UserWorkspace {
  userId      String    @map("user_id") @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  role        String
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  user      Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@id([userId, workspaceId])
  @@index([deletedAt], map: "user_workspaces_deleted_at_idx")
  @@index([workspaceId], map: "user_workspaces_workspace_id_idx")
  @@map("user_workspaces")
}

model UserDevice {
  userId    String    @map("user_id") @db.Uuid
  deviceId  String    @map("device_id") @db.Uuid
  role      String
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  device Device  @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@id([userId, deviceId])
  @@index([deletedAt], map: "user_devices_deleted_at_idx")
  @@index([deviceId], map: "user_devices_device_id_idx")
  @@map("user_devices")
}

model RoleAuditLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tableName String    @map("table_name")
  recordId  String    @map("record_id")
  userId    String    @map("user_id") @db.Uuid
  action    String
  oldValues Json?     @map("old_values")
  newValues Json?     @map("new_values")
  changedAt DateTime  @default(now()) @map("changed_at") @db.Timestamptz

  user Profile @relation(fields: [userId], references: [id])

  @@index([tableName, recordId], map: "role_audit_log_table_record_idx")
  @@index([userId], map: "role_audit_log_user_id_idx")
  @@map("role_audit_log")
}

model MqttCredential {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username      String    @unique
  password      String
  allocatedUuid String    @unique @map("allocated_uuid") @db.Uuid
  claimedAt     DateTime? @map("claimed_at") @db.Timestamptz

  @@index([claimedAt], map: "mqtt_credentials_claimed_at_idx")
  @@map("mqtt_credentials")
}
